#!/bin/bash
set -euxo pipefail

dnf update -y
dnf install -y docker git
systemctl enable docker
systemctl start docker

# Install docker compose plugin
DOCKER_CONFIG=${DOCKER_CONFIG:-/usr/lib/docker}
mkdir -p /usr/local/lib/docker/cli-plugins/
curl -SL https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-linux-x86_64 -o /usr/local/lib/docker/cli-plugins/docker-compose
chmod +x /usr/local/lib/docker/cli-plugins/docker-compose

mkdir -p /opt/app
cd /opt/app

if [ -n "${repo_url}" ]; then
  git clone "${repo_url}" repo
  cd repo
  git checkout "${repo_branch}"
  # Export env for backend container
  export AWS_REGION=${AWS_REGION:-$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq -r .region || echo "eu-central-1")}
  export NEO4J_CONNECTION_PARAM=${NEO4J_CONNECTION_PARAM:-"/org-chart/neo4j_connection_string"}
  export API_KEY_PARAM_PATH=${API_KEY_PARAM_PATH:-"/org-chart/api-keys"}
  # Pass env vars to compose
  echo "AWS_REGION=$AWS_REGION" > .env
  echo "NEO4J_CONNECTION_PARAM=$NEO4J_CONNECTION_PARAM" >> .env
  echo "API_KEY_PARAM_PATH=$API_KEY_PARAM_PATH" >> .env
  docker compose -f infrastructure/docker-compose.yml up -d --build
else
  echo "No repo_url provided, skipping deployment"
fi


